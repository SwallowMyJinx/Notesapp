{% extends "base.html" %}
{% block title %}Meine Notizen{% endblock %}
{% block content %}

<!-- Filter-Chips -->
<div class="mb-4 flex flex-wrap items-center gap-2">
  <a href="{% url 'note_list' %}"
     class="px-3 py-1.5 rounded border border-white/10 {% if not active_color %}bg-white/10{% endif %}">
     Alle
  </a>
  {% for c, bg, label in labels %}
    <a href="{% url 'note_list' %}?color={{ c }}"
       class="px-3 py-1.5 rounded border border-white/10 flex items-center gap-2
              {% if active_color == c %}bg-white/10{% endif %}">
      <span class="inline-block w-3 h-3 rounded {{ bg }}"></span>
      <span class="text-sm">{{ label|default:c|capfirst }}</span>
    </a>
  {% endfor %}
</div>

<!-- Notizen-Grid -->
<div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
  {% for note in notes %}
    <div class="
      p-4 rounded-xl shadow text-black flex flex-col justify-between
      {% if note.color == 'yellow' %}bg-yellow-400{% elif note.color == 'green' %}bg-green-400
      {% elif note.color == 'blue' %}bg-blue-400{% elif note.color == 'purple' %}bg-purple-400
      {% elif note.color == 'pink' %}bg-pink-400{% elif note.color == 'gray' %}bg-gray-400
      {% elif note.color == 'red' %}bg-red-400{% elif note.color == 'orange' %}bg-orange-400
      {% else %}bg-yellow-400{% endif %}
      {{ note.deadline_border_class }}
    ">
      <div class="flex items-start justify-between gap-3">
        <h2 class="font-bold text-lg">{{ note.title|default:"(ohne Titel)" }}</h2>

        {% if note.deadline %}
          <!-- Deadline-Chip -->
          <span class="{% if note.deadline_chip_class %}{{ note.deadline_chip_class }}{% else %}inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs border bg-gray-100 border-gray-300 text-gray-800{% endif %}">
            ⏰ {{ note.deadline|date:"d.m.Y" }}
            {% if note.deadline_text %}
              <span class="opacity-80">· {{ note.deadline_text }}</span>
            {% else %}
              {# Fallback, wenn View-Helper noch nicht aktiv ist #}
              {% if note.deadline < today %}
                <span class="opacity-80">· Überfällig</span>
              {% elif note.deadline == today %}
                <span class="opacity-80">· Heute</span>
              {% else %}
                <span class="opacity-80">· Ok</span>
              {% endif %}
            {% endif %}
          </span>
        {% endif %}
      </div>

      <p class="mt-2">{{ note.content }}</p>

      <small class="block mt-2 text-xs">Geändert: {{ note.updated_at|date:"d.m.Y H:i" }}</small>

      <div class="mt-3 flex items-center gap-2">
        <a href="{% url 'edit_note' note.id %}"
           class="px-3 py-1.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">✏️ Bearbeiten</a>

        <form action="{% url 'delete_note' note.id %}" method="post"
              onsubmit="return confirm('Diese Notiz wirklich löschen?');">
          {% csrf_token %}
          <button class="px-3 py-1.5 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">
            🗑️ Löschen
          </button>
        </form>

        <button type="button"
                class="px-3 py-1.5 rounded-lg bg-black/30 text-black hover:bg-black/40 transition"
                @click="$store.palette.open({{ note.id }})">
          🎨 Farbe
        </button>

        {% if note.label_text %}
          <span class="ml-auto px-2 py-1 rounded-full bg-black/20 text-xs font-medium">
            {{ note.label_text }}
          </span>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p>Keine Notizen vorhanden.</p>
  {% endfor %}
</div>
{% endblock %}
